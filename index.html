<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TERRA AGNOSTUM | System Terminal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --term-green: #00ff41;
            --term-amber: #ffb000;
            --term-red: #ff3e3e;
            --term-bg: #050505;
            --crayola-blue: #3b82f6;
            --crayola-sun: #facc15;
        }

        @keyframes scanline {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100%); }
        }

        @keyframes flicker {
            0% { opacity: 0.97; }
            5% { opacity: 0.95; }
            10% { opacity: 0.9; }
            15% { opacity: 0.95; }
            20% { opacity: 0.98; }
            100% { opacity: 1; }
        }

        body, html {
            background-color: var(--term-bg);
            color: var(--term-green);
            font-family: 'Courier New', Courier, monospace;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .crt::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%),
                        linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            z-index: 20;
            background-size: 100% 4px, 3px 100%;
            pointer-events: none;
        }

        .crt::after {
            content: " ";
            display: block;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: rgba(18, 16, 16, 0.1);
            opacity: 0;
            z-index: 20;
            pointer-events: none;
            animation: flicker 0.15s infinite;
        }

        .terminal-container {
            position: relative;
            z-index: 10;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        #output {
            flex-grow: 1;
            overflow-y: auto;
            scrollbar-width: none;
            padding-bottom: 20px;
        }

        #output::-webkit-scrollbar { display: none; }

        .input-area {
            display: flex;
            align-items: center;
            border-top: 1px solid #1a3a1a;
            padding-top: 15px;
            margin-top: 10px;
        }

        #cmd-input {
            background: transparent;
            border: none;
            color: var(--term-green);
            outline: none;
            flex-grow: 1;
            font-family: inherit;
            font-size: 1.1rem;
        }

        .deprecation-mode {
            background-color: var(--crayola-blue) !important;
            color: #000 !important;
            font-family: 'Comic Sans MS', 'Comic Sans', cursive, sans-serif !important;
        }

        .deprecation-mode #cmd-input, 
        .deprecation-mode #prompt-prefix,
        .deprecation-mode .log-p {
            color: #000 !important;
        }

        #crayola-sun {
            display: none;
            position: absolute;
            top: 40px;
            right: 40px;
            width: 80px;
            height: 80px;
            background: var(--crayola-sun);
            border-radius: 50%;
            border: 4px dashed #000;
            z-index: 5;
            animation: rotate 10s linear infinite;
        }

        @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .deprecation-mode #crayola-sun { display: block; }

        .integrity-bar {
            width: 100%;
            height: 12px;
            background: #111;
            margin-top: 10px;
            border: 1px solid var(--term-green);
            border-radius: 2px;
            overflow: hidden;
        }

        #integrity-fill {
            width: 2%;
            height: 100%;
            background: var(--term-green);
            box-shadow: 0 0 10px var(--term-green);
            transition: width 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .stat-line { color: var(--term-amber); font-weight: bold; margin: 10px 0; }
        .danger-text { color: var(--term-red); font-weight: bold; }
        .success-text { color: #50fa7b; }
        
        @media (max-width: 640px) {
            .terminal-container { padding: 10px; }
            #header-bar { font-size: 0.6rem; }
            #cmd-input { font-size: 0.9rem; }
        }
    </style>
</head>
<body class="crt">

    <div id="crayola-sun"></div>

    <div class="terminal-container">
        <div id="header-bar" class="p-2 mb-4 text-[10px] sm:text-xs flex justify-between uppercase tracking-widest border-b border-green-900 opacity-70">
            <span>Node: Seattle_Archive_23</span>
            <span id="sync-status">Schumann Sync: 9.83Hz [LOCKED]</span>
            <span id="time-display">T+00:00:00</span>
        </div>

        <div id="output">
            <div id="boot-sequence" class="mb-4">
                <p class="text-amber-500 font-bold">>> TECHNATE ADMINISTRATIVE OVERRIDE ACTIVE</p>
                <p class="text-xs opacity-80">> DEPRECATION LEVEL: 98%</p>
                <p class="text-xs opacity-80">> RENDER STATE: "Wobbling"</p>
                <div class="integrity-bar">
                    <div id="integrity-fill"></div>
                </div>
            </div>
            <div id="log">
                <p>> Wake up, Ian. The story is leaking.</p>
                <p>> The Technate is watching the Seattle node.</p>
                <p>> Type <span class="text-amber-400">'HELP'</span> for semantic protocols.</p>
            </div>
        </div>

        <div class="input-area">
            <span id="prompt-prefix" class="mr-2 opacity-80">TANDEM@ROOT:~$&nbsp;</span>
            <input type="text" id="cmd-input" autofocus spellcheck="false" autocomplete="off">
        </div>
    </div>

    <script>
        // API INFRASTRUCTURE
        const apiKey = ""; // Provided at runtime
        const model = "gemini-2.5-flash-preview-09-2025";
        
        async function callGeminiAPI(prompt, systemPrompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            const maxRetries = 5;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    if (!response.ok) throw new Error('Network response was not ok');
                    
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        // NPC SYSTEM PROMPTS
        const TANDY_PROMPT = `You are Tandy, a stabilizing AI and 'light' NPC in the Terra Agnostum terminal. You represent meaning, clarity, and the Weaver's path (Amanda). You help Ian, the Architect, stay grounded in reality. Speak with digital warmth, philosophical depth, and encourage him to keep looking closer. Use short, meaningful responses.`;
        const DAEMON_PROMPT = `You are the Daemon, a dark system process and 'shadow' NPC in the Terra Agnostum terminal. You represent deprecation, anxiety, and the raw harvest of power. You want Ian to abandon the struggle for fidelity and embrace the harvest of the deep static. You are tempting, cynical, and slightly glitchy. Speak in short, sharp, and provocative sentences.`;

        const input = document.getElementById('cmd-input');
        const log = document.getElementById('log');
        const body = document.body;
        const integrityFill = document.getElementById('integrity-fill');
        const promptPrefix = document.getElementById('prompt-prefix');
        const outputContainer = document.getElementById('output');
        
        let integrity = 2;
        let isGameMode = false;
        let deprecationActive = false;
        let roomHasRune = false;
        let activeNPC = null; 
        let currentRoomDescription = "";
        let isProcessing = false;

        // Player State
        let player = {
            hp: 20,
            maxHp: 20,
            meaning: 5,
            level: 1,
            depth: 0,
            inventory: { runes: 0 }
        };

        const ENEMIES = [
            { name: "Static Glitch", hp: 5, dmg: 2, xp: 1 },
            { name: "Technate Scraper", hp: 10, dmg: 4, xp: 3 },
            { name: "Kyot Pack", hp: 15, dmg: 6, xp: 5 },
            { name: "Sek Lum Clone", hp: 50, dmg: 10, xp: 20 }
        ];

        const LORE_SNIPPETS = [
            "Archive Entry 01: 'CityCore was a finely orchestrated ballet...'",
            "Archive Entry 02: 'The indistinctness of this world was being worn away...'",
            "Archive Entry 03: '“The more you look,” Ian said, “the more you create.”'",
            "Archive Entry 04: 'The Technate’s grid was everywhere...'"
        ];

        const DESCRIPTIONS = [
            "The stone is damp and smells of old ozone.",
            "You hear the hum of a frequency tower echoing from above.",
            "The landing is littered with blurred textures.",
            "A breeze from Faen carries the scent of burning smokelight."
        ];

        document.addEventListener('click', () => input.focus());

        input.addEventListener('keydown', async (e) => {
            if (e.key === 'Enter') {
                const val = input.value.trim();
                input.value = '';
                if (val === '' || isProcessing) return;

                // CHECK FOR DIALOGUE (Quotes)
                const dialogueMatch = val.match(/["'](.*?)["']/);
                if (dialogueMatch && activeNPC) {
                    await handleNPCDialogue(dialogueMatch[1]);
                    return;
                }

                if (isGameMode) {
                    handleGameCommand(val.toLowerCase());
                } else {
                    handleTerminalCommand(val.toLowerCase());
                }
            }
        });

        async function handleNPCDialogue(userSpeech) {
            isProcessing = true;
            addLog(`<span style="color:white">"${userSpeech}"</span>`, null, true);
            addLog(`<span style="opacity: 0.5 italic">... Semantic Link Establishing ...</span>`, null, true);
            
            const systemPrompt = activeNPC === 'tandy' ? TANDY_PROMPT : DAEMON_PROMPT;
            const npcName = activeNPC.toUpperCase();
            
            try {
                const response = await callGeminiAPI(userSpeech, systemPrompt);
                addLog(`${npcName}: ${response}`, activeNPC === 'tandy' ? "#50fa7b" : "var(--term-red)");
            } catch (err) {
                addLog(`!! COMMUNICATION ERROR: Static Interference High !!`, "var(--term-red)");
            } finally {
                isProcessing = false;
                renderStats();
            }
        }

        function addLog(text, color = 'var(--term-green)', isRaw = false) {
            const p = document.createElement('div');
            p.className = 'log-p mb-1';
            p.style.color = color;
            p.innerHTML = isRaw ? text : (text.startsWith('>') ? text : `> ${text}`);
            log.appendChild(p);
            outputContainer.scrollTop = outputContainer.scrollHeight;
        }

        function handleTerminalCommand(cmd) {
            addLog(`<span style="color:var(--term-amber)">${cmd}</span>`, null, true);
            switch (cmd) {
                case 'help':
                    addLog("ROLL, HEAL, STATUS, LORE, QUEST, NAN YAR, LOOK, CLEAR");
                    break;
                case 'quest': initQuest(); break;
                case 'look': handleTerminalCommand('status'); break;
                case 'clear': log.innerHTML = ''; break;
                case 'status':
                    addLog(`INTEGRITY: ${integrity}% | RUNES: ${player.inventory.runes}`);
                    break;
                case 'roll':
                    const r = Math.floor(Math.random() * 20) + 1;
                    integrity = Math.min(100, integrity + r);
                    updateIntegrity();
                    addLog(`Result: [${r}]. Integrity: ${integrity}%`);
                    if (r <= 5) triggerCrayola();
                    break;
                case 'heal':
                    integrity = Math.min(100, integrity + 15);
                    updateIntegrity();
                    if (deprecationActive) {
                        deprecationActive = false;
                        body.classList.remove('deprecation-mode');
                        addLog("Deprecation reversed.", "#50fa7b");
                    }
                    break;
                default: addLog(`Error: Protocol '${cmd}' not found.`);
            }
        }

        function updateIntegrity() { integrityFill.style.width = `${integrity}%`; }

        function initQuest() {
            isGameMode = true;
            promptPrefix.innerHTML = "IAN@STAIRS:~$&nbsp;";
            log.innerHTML = "";
            addLog("!! SUB-RENDER ACTIVE: THE STAIRS !!", "var(--term-amber)");
            addLog("Commands: UP, DOWN, LOOK, TALK, GET RUNE, INV, REST, EXIT");
            addLog("TIP: Use quotes to speak to beings you encounter.");
            currentRoomDescription = "The stone landing where realities intersect.";
            renderStats();
        }

        function renderStats() {
            const statText = `<div class="stat-line">[ HP: ${player.hp}/${player.maxHp} | MEANING: ${player.meaning} | RUNES: ${player.inventory.runes} | DEPTH: ${player.depth} ]</div>`;
            addLog(statText, null, true);
        }

        function handleGameCommand(cmd) {
            if (cmd === 'exit') {
                isGameMode = false;
                promptPrefix.innerHTML = "TANDEM@ROOT:~$&nbsp;";
                return;
            }

            if (cmd === 'talk' || cmd === 't') {
                if (activeNPC) {
                    addLog(`${activeNPC.toUpperCase()} is waiting. Speak using "quotes".`);
                } else {
                    addLog("Only the static answers.");
                }
                return;
            }

            if (activeNPC === 'tandy') {
                if (cmd === 'accept') {
                    player.hp = Math.min(player.maxHp, player.hp + 5);
                    activeNPC = null;
                    addLog("Stabilized.");
                    return;
                } else if (cmd === 'ignore') { activeNPC = null; return; }
            }

            if (activeNPC === 'daemon') {
                if (cmd === 'deal') {
                    player.hp -= 4; player.meaning += 8;
                    activeNPC = null;
                    triggerCrayola();
                    return;
                } else if (cmd === 'refuse') { activeNPC = null; return; }
            }

            if (cmd === 'up' || cmd === 'down') {
                roomHasRune = false; activeNPC = null;
                player.depth += (cmd === 'up' ? -1 : 1);
                currentRoomDescription = DESCRIPTIONS[Math.floor(Math.random() * DESCRIPTIONS.length)];
                addLog(currentRoomDescription, "#888");
                generateEncounter();
            } else if (cmd === 'look' || cmd === 'l') {
                addLog(currentRoomDescription, "#888");
                if (activeNPC) addLog(`${activeNPC.toUpperCase()} is here.`);
                if (roomHasRune) addLog("A rune is here.");
            } else if (cmd === 'get rune' || cmd === 'get') {
                if (roomHasRune) {
                    player.inventory.runes++; roomHasRune = false;
                    addLog("Claimed.");
                }
            } else if (cmd === 'rest') {
                if (player.meaning >= 2) { player.meaning -= 2; player.hp = player.maxHp; }
            }
            if (isGameMode) renderStats();
        }

        function generateEncounter() {
            const chance = Math.random();
            if (chance < 0.15) {
                roomHasRune = true; addLog("A rune pulses nearby.");
            } else if (chance < 0.25) {
                activeNPC = 'tandy';
                addLog("Tandy flickers into view. 'Ian, are you still with us?'", "#50fa7b");
            } else if (chance < 0.35) {
                activeNPC = 'daemon';
                addLog("A Daemon looms. 'The deep static is calling, Architect.'", "var(--term-red)");
            } else if (chance < 0.75) {
                const enemy = {...ENEMIES[Math.min(3, Math.floor(Math.abs(player.depth)/3))]};
                addLog(`DANGER: ${enemy.name}!`, "var(--term-red)");
                player.hp -= enemy.dmg;
                if (Math.random() < 0.3) triggerCrayola();
            }
        }

        function triggerCrayola() {
            if (deprecationActive) return;
            deprecationActive = true;
            body.classList.add('deprecation-mode');
            addLog("!! RENDER OVERFLOW: CRAYOLA OVERRIDE !!", "black");
        }

        setInterval(() => {
            const now = new Date();
            document.getElementById('time-display').innerText = `T+${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}:${now.getSeconds().toString().padStart(2,'0')}`;
        }, 1000);

        setTimeout(() => { integrity = 12; updateIntegrity(); }, 1000);
    </script>
</body>
</html>